\setlength{\headheight}{1.2cm}
\renewcommand{\publ}{\flushleft\footnotesize{}}

\chapter{Conclusions and Future Work}\label{chap:8}
This chapter summarises the contributions of this PhD project and concludes the dissertation.
Section \ref{c8:sec:rq-contributions} revisits each research question and answers them according to the findings of the respective empirical studies.
Section \ref{c8:sec:future-work} concludes the chapter by exploring future research directions that stem from the work presented in this dissertation.

\section{Research Questions and Contributions}\label{c8:sec:rq-contributions}
The problem statement addressed by this dissertation is stated in Chapter \ref{chap:introduction} and repeated here for convenience: \textit{The detection of the architectural smells alone is not sufficient for practitioners to take informed TD management decisions. Practitioners need to know what the available prioritisation strategies are, the amount of TD each instance amounts to, and the trend of the TD incurred over time. This information can help them better plan TD repayment.}
To tackle this problem, we decomposed it into six research questions (five knowledge questions and one design problem) and answered them in Chapters \ref{chap:2} to \ref{chap:7}.
Each RQ addresses a particular aspect of the problem statement.

RQ1 addresses the lack of existing prioritisation strategies that can be used by practitioners and provides guidance on what type smell instances are more severe than others.
Next, RQ2 allows us to better understand the needs of practitioners and the current state of practice with respect to architectural smells management in industry.
Then, RQ3 tests our analysis on the field, in a real world industrial context, and collects information on the evolution of smells. This information is used to refine the prioritisation strategies collected in RQ1 from open source systems.
RQ4 addresses the relation of smells with changes in the source code in order to understand the advantages of repaying the ATD generated by architectural smells.
RQ5 formulates a solution for the quantification and monitoring of the amount of TD principal by also using the results obtained from previous RQs.
RQ6 addresses the knowledge gap of how practitioners perform TD repayment and how prioritising other quality attributes over maintainability affects TD.
%Each chapter corresponds to an empirical study that aims at solving one aspect of the problem stated above.
% Overall, the first four chapters investigate the degree to which architectural smells impact practitioners, both from the perspective of the code and from the perspective of the practitioners themselves.
% Specifically, Chapter \ref{chap:2} (RQ1) is focused only on analysing the smells detected in a number of systems;
% Chapter \ref{chap:3} (RQ2) focuses on understanding the experiences of practitioners with AS; Chapter \ref{chap:4} (RQ3) combines these two aspects into a single study, so that the answers provided by practitioners can be backed up by the quantitative data collected, and vice-versa; and finally Chapter \ref{chap:5} (RQ4) the correlation of architectural smells with the number and size of changes done in the source code by practitioners.
% Chapter \ref{chap:6} (RQ5) combines the findings from previous studies into a solution that can actually be used by practitioners to better manage the technical debt generated by architectural smells.

% This addresses the problem statement because the approach resulting from RQ5 allows practitioners to \emph{quantify} the TD, \emph{prioritise} individual TD items (i.e. the AS), and \emph{monitor}, using a single index, the TD for all the AS in the system.
% Moreover, the answers to RQ1-4 also provide general guidelines on how to prioritise AS and take decisions based the information available.
% Finally, RQ6 focuses on the problem horizontally by looking at the trade-offs that force practitioners to incur TD, and what quality attributes they prioritise over maintainability.

The upcoming paragraphs summarise the answer to each research question based on the empirical evidence collected.

\subsubsection*{RQ1: How do AS evolve in open source systems?}
To answer this research question, we carried out an empirical study that investigated how individual instances of architectural smells evolve over time and persist within the system.
To do so, we detected the architectural smells in 524 releases of 14 different Java projects. 
We also developed an approach to track each instance of an architectural smell with its counterpart from the next version.
This allowed us to create a time series data set about architectural smell instances.

The findings showed that different smell types evolve in different ways; for example, most cycles tend to stay constant regarding the number of elements affected (size) but tend to increase in total number of instances.
The opposite holds for the Hublike Dependency (HL) smell, which tends to increase in size instead of in number of instances detected.
Cycle instances were also found to be less persistent within the system, and after a few releases most of them might disappear\footnote{Note that cycles are replaced by different instances involving the new classes and packages added to the system.} as a consequence of the changes done in the system.

Given these findings, we deduced general prioritisation rules:
\begin{enumerate}
\item \emph{HL smells should be addressed before cycles} because individual cycle instances are less likely to affect maintenance effort (i.e. TD interest) on the long term;
\item refactoring should not focus on \emph{CD instances that were recently introduced} as many CD instances are likely to disappear in the next releases. This confirms state of the art findings that many CD instances are not critical \cite{AlMutawa2014};
\item not all CD instances have the same severity, some instances may be intentional. Refactoring activities should prioritise \emph{complex shapes} that affect central parts of the system as they are more likely to incur extra maintenance effort.
\end{enumerate}

The contributions compared to the state of the art are that this study is the first study to look at the evolution of \emph{individual} architectural smell instances and at their survival probability within the system.
Additionally, it is also the first to deduce general prioritisation rules among the smell types considered in the study.

\subsubsection*{RQ2: How are AS perceived by industrial practitioners?}
This research question was investigated by an empirical study.
In this case, however, instead of mining and analysing software repositories, we interviewed 21 software engineers and architects on their experience with AS.
The data collected through the interviews gave us an insight on how practitioners perceive AS, how they introduce them as well as the maintenance and evolution issues related to smells. 

The results showed that practitioners perceive the God Component (GC) smell as a common cause of maintenance issues, mainly as a result of the high level of complexity that characterizes its instances. 
Cyclic dependencies were perceived less detrimental than GC, especially among practitioners working with Java systems. A similar opinion was given about the HL smell.
Practitioners expressed their concern about change ripple effects associated with the UD smell, but they also reported that the smell type (which theoretically is responsible for an increase in change rate in the system) is rather hard to understand and not very intuitive. 

HL and GC smells seemed to be the most commonly labelled as intentionally introduced, although practitioners also mentioned that they grew larger in size than what was intended.
This resulted in practitioners being reluctant to refactor them.
CD instances were instead attributed to bad initial design decisions that resulted in the introduction of cycles, which made them easier candidates for refactorings.

Another interesting finding is that practitioners perceived the presence of AS, in most cases, as a ``necessary evil'' in order to be able to meet deadlines and budget limitations.
This shows that practitioners are aware and well-informed about good design practices, but they struggle following them diligently.
It also confirmed that the problem statement is relevant to practitioners and that they require further support to manage AS.

The novelty of this study is that it is the first to report on the opinion of software practitioners on architectural smells using one-to-one, in-depth interviews as the main data collection method with the participants belonging to different companies. Previous studies used focus groups only and focused on a single company only.

\subsubsection*{RQ3: How do AS evolve in industrial embedded systems?}
To answer this research question, we designed an empirical case study in an industrial setting.
This study differs from the one performed to answer RQ1 because it includes both quantitative and qualitative data. Moreover, it focuses on C/C++ industrial embedded systems rather than Java systems.
In the study we analysed over 20 millions lines of code, 30 releases, 9 projects, and interviewed 12 software engineers and architects.

The findings derived from the quantitative analysis showed that most CD instances follow rather different growth patterns that those observed in open source systems, with a large percentage of CD instances that grow in size over time rather than in number, thus becoming more severe.
Cycles were found to be precursors of other smells, whereas HL smells were found to be the \emph{most common} successor type of smell.
Moreover, CD were found to be very common in GC smells, as more than 85\% of CD instances co-occur with GC instances.
GC instances instead seemed to be least co-occurring with HL smells , with the only 10\% of GCs co-occurring with HL instances.

The findings of the qualitative analysis highlighted that practitioners are aware of the presence of smells and can use intuition to pinpoint the problem but they need assistance in \emph{tracking} and \emph{quantifying} their presence \emph{deterministically}.
Moreover, practitioners also mentioned that change propagation to unknown parts of the codebase is one of their main struggles during typical maintenance activities.
These issues were especially associated with the components affected by smells. 

The novel contributions of this study to the state of the art are that it is the first to present the evolution of individual AS instances in industrial systems. Additionally, this study also focuses on C/C++ programming languages, which is quite rare to see in the literature as most studies use Java instead.
It is also the first study that provides a double perspective on the evolution of the smells in a single paper: the perspective from mining software repositories, and the opinion of the practitioners that worked on the code analysed.

\subsubsection*{RQ4: How do AS correlate to changes in the source code of the system?}
To investigate this research question, we set up an empirical study to analyse 31 Java projects for a total of over 3900 commits.
The analysis compared the frequency and size of changes in affected and non-affected classes and packages.
To do so, we used several different statistical tests while also controlling for the confounding factor of the size of the project, classes, and packages.

The results show that in 82\% of the analysed commits the proportion of smelly artefacts that change is consistently higher than non-smelly artefacts that change.
Medium and large artefacts that are affected by smells are naturally more likely to exhibit this difference in change frequency than small artefacts.
Similarly, artefacts that exhibit changes are also more likely to have more smells than artefacts that have fewer smells, regardless of the size of the artefact.
Artefacts with smells were also found to have larger change size (code churn) than non smelly artefacts, with the effect being more noticeable in larger artefacts.
Finally, when a smell is introduced to an artefact, the change frequency of the artefact increases afterwards.

While these findings do not provide evidence that architectural smells are directly responsible for an increase in the frequency of change of the artefacts affected, they do confirm that the presence of architectural smells indicates the presence of \emph{hotspots} in the design and code of the system.

Compared to the state of the art, this is not the first study that analyses the correlation between AS and source code changes. However, it is the first that provides a comprehensive analysis of the relation between changes and smells by looking not only at frequency of change, but also at the size of the changes and how the introduction of a smell instance affects the changes of a specific class/package.
Moreover, it also includes 31 systems in the analysis, making the findings more generalisable, as most other studies had analysed 20 at maximum.

\subsubsection*{RQ5: Design an approach to estimate the technical debt principal generated by AS}
This research question represents a rather complicated problem to solve, that required solving first two design sub-problems: (1) how to calculate the severity of an architectural smell, and (2) how to quantify the effort to remove a smell.

To solve the first design problem, we designed a machine learning model that ranks architectural smells based on their severity. 
This required first to create a data set that comprised examples of smells instances with different severity. The data set was manually annotated using the findings from RQ1 to RQ4 (and the state of the art) as guidelines. 

To solve the second design problem, we used the number of lines of code that are responsible for the presence of the smell, and therefore must be understood and changed by the developer.
This solution ultimately resulted in a static analysis tool that precisely calculates these values.

Finally, we combined the two solutions to calculate the ATD index and designed a case study to validate our approach.
In total, we interviewed 16 practitioners, 9 that worked on open source projects (either full-time or as a hobby) and 7 from two companies.
From the interviews, it emerged that practitioners agreed with the estimations provided in 71\% of the cases and that these were \emph{representative of the effort} necessary to refactor a smell.
Moreover, they also mentioned that TD repayment was not always an option for them as it would force them to make a trade-off that they were not willing to.

The main contribution of this study to the state of the art, is that it is the first study that uses machine learning to solve this problem.
The advantage provided is that our approach does not require manually-set thresholds nor a benchmark of systems to perform the estimations of TD principal.
Additionally, our approach is the only one validated through an empirical study that involves practitioners from both industry and open source.

\subsubsection*{RQ6: How are trade-offs between quality attributes currently managed in industry?}
We answered this research question by conducting a case study, set up in an industrial setting.
To collect the necessary data, we performed two rounds of interviews and a focus group.
In particular, during the first round we interviewed 8 practitioners from 3 different companies operating in the embedded systems domain.
Then we performed a focus group with 8 more practitioners from 4 companies, 3 of which were the same from the interviews.
We concluded the data collection with the second round of interviews, where we performed 6 more interviews.
In total, we consulted 21 software engineers and architects.

The results showed that practitioners prefer prioritising run-time qualities (e.g. performance, availability, etc.) over design-time qualities (e.g. maintainability, testability, etc.) citing as the main reason, domain aspects (e.g. extreme optimisation) and business aspects (e.g. demos, deadlines), which take priority over code and architecture quality.
Practitioners also mentioned how some of these trade-offs backfired eventually, hampering their ability to meet existing performance requirements or deliver new functionality on time. 

The main novelty of this study compared to the state of the art is that this study is the only one that reports examples of actual trade-offs among quality attributes from an industrial setting.

\section{Future Work}\label{c8:sec:future-work}
The work presented in this thesis provides several opportunities for future work.
We group these opportunities into two main research branches:
(1) continue the research on architectural smells and link with the TD metaphor; and (2) refactoring support.


\subsection{Strengthen the link between AS and the TD metaphor}
One opportunity for future work lies in continuing to improve the link between the technical debt metaphor and architectural smells.
The ultimate goal of this research line is to make it possible for practitioners to manage ATD efficiently.

One concrete example of future work is estimating the amount technical debt interest\footnote{Also known as the cost of keeping the current solution as is.} generated by architectural smells.
By using this data point, one can calculate the breaking point, i.e. the time left before rebuilding the system from scratch is more convenient than keep maintaining it.
This would allow practitioners to plan ATD repayment activities more efficiently.
Additionally, by using TD interest, practitioners can decide to focus refactoring activities only on the parts of the system where interest is paid the most.


\subsection{Refactoring support}
An interesting opportunity for future work is studying how architectural smell instances can be refactored automatically.
This is a rather ambitious research direction that may not even be completely feasible.
However, even providing developers with partial refactoring solutions that can be used as a starting point to design a complete solution would be, by itself, an impressive achievement.
The advantage provide by this solution is that if refactoring becomes easier for practitioners to apply then they will be more prone to adopt techniques to manage ATD.

A more concrete possibility for future work in this research direction is to quantify the impact of a single refactoring step  on the system.
For example, estimating the files that need to change in order to remove a dependency between two, or more, classes or packages.


%\subsection{d}
%Technical debt is not the only variable that influences practitioners' decisions.
%Another interesting research line for future work is studying how trade-offs can be .

%From AS evolution paper
% $^\dagger$ marks characteristics not studied in this study as they are intended as future work.


% Research on architectural smells
% Tradeoffs with energy efficiency and performance
% Real time Impact analysis of changes in source code 
% Automatic refactoring

% Research on tool support for software processes
% - How to make the correct information available at the right time, and the right person: integrate data from multiple sources and link it together.
% - IR/ML in software engineering to support decisions
% - 